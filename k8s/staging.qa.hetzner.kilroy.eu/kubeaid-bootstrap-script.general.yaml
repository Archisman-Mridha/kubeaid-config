forkURLs:
  kubeaid:
    url: https://github.com/Obmondo/KubeAid
    version: 20.1.2

  kubeaidConfig:
    url: https://github.com/Archisman-Mridha/kubeaid-config
    directory: staging.qa.hetzner.kilroy.eu

cluster:
  name: qa-staging-hetzner
  k8sVersion: v1.32.0

  additionalUsers:
    - name: archi
      sshPublicKey: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQC6dc7jP7zQT7qSKkFJd4pOMZmTb0kx8R29A3DbzLaDSSepEGtJ+64taQ4YI1C5/l7BFdi8blb1N135tRf54YY1v1plFDzukjxMx8GLa965T4YuSPg/1PhNQfsUcGDL/LXMktJiJP8pYvQKnOjM6KHju1GJKPlmlWHkttyFk6KmkeltF+ljPRGJhpOUjvM9RJgsYqiy6+pb8hGKxQi4dQ07duj7y7N/0pPbHg/BrtpbtHm2r/fsrFfzVwqIRg61LKxrcTZ4HPGpKPoare+X+wbp85hQOfWr6KtG9cQMjGbneZTYAYXhQxYlr2XlbGq/yj9mQJxYg/rEIL/EQY12An4zdI2hqpNlgkZwioc2agCGs3HvtQY64gpSF/M530Wx6Dm2e9eltSj+frr+WJdz3QXqO84dUENllFavL+gSGuT+MBzYOCsCAlKzKEj1EZ4ivkpYaNvTNrVqFpNMPsvuX3nAjlcl3g2Wmkb+hjPjTH84glNEvFsc2FYLSaU46jyb6UJ3aSUaJsCBIQfp4C6BVAYwEe9OzvuJrp8Ky4P5C0t0UvJgfdbUIh5TksTZ5QpyQiMvzpvmhJEWY+BEHHiI2a2ZRs8DPr9NZ0M6aut0AfxdM3YxIRcNU1m8lJc37/QgQETuzKCnQzZwsJF/HdVuXv+VW39kstpvRO/o5ORGaCg/SQ== cardno:13_819_971
    - name: miku
      sshPublicKey: ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC7mC8X6xgtxmoRD4OUgydH9GUrmt+XSx3KfdQUkDGrjB9TfQvVSyuXPU4LRNAR8KBaE/byUzv8JSVCwsi3GJLPRRbboYmmsKwwi1Mh+DiVybN3gEoiGTwBEQR+Ukw2xi2MIFEli4QESeILKgd7Cp+ckV7IHb3lwoJs+2R9ihSqOCqFw0f1+y33bBGNtxjU1e1kD6ocUXtu320cUUcrTTSp6qC2UWJzST6rJA763EO7oG7xBKwJ0CwlFJB4aAz2nzyltVZ4SVYEq72gQvYKzo0w0oCplRm05EhBPseZ31B111V0/CIg2clUri32L0O1jTCWVk0C6Ud77UPFa9x4t0AZeG2bJTmrGMjLMDgjUZwRUdRq15mTu1LKojI81VDeci2IlfBiW/2jPfn1KZewln7442MnEzdJhuCdUhEaE8giSPhvM9aQWuLY+dwb0Ua3Gh8Joeu7pQWaWqI5m/aJVFV38zduUAl6RYZY84b2DCnMmzi6HMCUX5/KmUYFbJBcBNc= miku@miku-10
    - name: dast
      sshPublicKey: ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEjAzVkHcukDBp+cc2EMQyIs1WtHUXYlCqS+j4jR3dn/  dast

cloud:
  hetzner:
    mode: hybrid

    vswitch:
      vlanID: 4001
      name: qa-staging-hetzner

    hcloud:
      zone: eu-central
      imageName: ubuntu-24.04
      sshKeyPairName: qa-staging-hetzner

    bareMetal:
      wipeDisks: False
      sshKeyPair:
        name: qa-staging-hetzner
        publicKeyFilePath: ./outputs/ssh/rsa/openssh/.key.pub
        privateKeyFilePath: ./outputs/ssh/rsa/openssh/.key
      diskLayoutSetupCommands: |
        set -e

        apt-get update -y
        apt install zfsutils-linux -y

        # For each NVMe disk,
        # allocate 50% of the remaining space (i.e., partitions nvme0n1p4 and nvme1n1p4) to the
        # primary ZFS pool,
        # and rest (i.e., partitions nvme0n1p5 and nvme1n1p5) to Rook CEPH.

        START=$(sgdisk -f /dev/nvme0n1)
        END=$(sgdisk -E /dev/nvme0n1)
        HALF=$(( START + (END - START) / 2 ))
        sgdisk -n 4:${START}:${HALF} -t 4:fd00 -c 4:"zpool" /dev/nvme0n1
        sgdisk -n 5:0:0 -t 5:fd00 -c 5:"" /dev/nvme0n1
        partprobe /dev/nvme0n1

        START=$(sgdisk -f /dev/nvme1n1)
        END=$(sgdisk -E /dev/nvme1n1)
        HALF=$(( START + (END - START) / 2 ))
        sgdisk -n 4:${START}:${HALF} -t 4:fd00 -c 4:"zpool" /dev/nvme1n1
        sgdisk -n 5:0:0 -t 5:fd00 -c 5:"" /dev/nvme1n1
        partprobe /dev/nvme1n1

        udevadm settle

        if zpool import -f primary >/dev/null 2>&1; then
          echo "Imported existing primary ZPool"
        else
          # Create a mirrored ZPool out of nvme0n1p4 and nvme1n1p4 partitions.
          zpool create primary mirror /dev/nvme0n1p4 /dev/nvme1n1p4

          # From that ZPool, set aside 50GB for ContainerD, by creating a ZVolume (thinly provisioned).
          #
          # A ZFS volume is a dataset that represents a block device. ZFS volumes are identified as
          # devices in the /dev/zvol/{dsk,rdsk}/pool directory.
          zfs create -s -V 50G primary/containerd
          udevadm settle
          mkfs.ext4 /dev/zvol/primary/containerd

          # From that ZPool, set aside 50GB for ephemeral volumes for pods, by creating a ZVolume (thinly provisioned).
          zfs create -s -V 50G primary/pod-ephemeral-volumes
          udevadm settle
          mkfs.ext4 /dev/zvol/primary/pod-ephemeral-volumes

          # From that ZPool, set aside 50GB for pod logs, by creating a (thinly provisioned)
          # ZVolume (thinly provisioned).
          zfs create -s -V 50G primary/pod-logs
          udevadm settle
          mkfs.ext4 /dev/zvol/primary/pod-logs
        fi

        mkdir -p /var/lib/containerd
        echo "/dev/zvol/primary/containerd /var/lib/containerd ext4 defaults,nofail 0 0" | tee -a /etc/fstab
        mount /dev/zvol/primary/containerd /var/lib/containerd

        mkdir -p /var/lib/kubelet/pods
        echo "/dev/zvol/primary/pod-ephemeral-volumes /var/lib/kubelet/pods ext4 defaults,nofail 0 0" | tee -a /etc/fstab
        mount /dev/zvol/primary/pod-ephemeral-volumes /var/lib/kubelet/pods

        mkdir -p /var/log/pods
        echo "/dev/zvol/primary/pod-logs /var/log/pods ext4 defaults,nofail 0 0" | tee -a /etc/fstab
        mount /dev/zvol/primary/pod-logs /var/log/pods

        # Enable weekly ZPool trimming for the ZPool.
        # So unused storage space will be reclaimed back, from the ZVolumes into the ZPool.
        # REFER : https://openzfs.github.io/openzfs-docs/man/master/8/zpool-trim.8.html.
        systemctl enable zfs-trim-weekly@rpool.timer --now

      ceph:
        deviceFilter: "^(nvme[01]n1p5)$"

    controlPlane:
      regions:
        - fsn1
        - nbg1
        - hel1

      hcloud:
        machineType: cax11
        replicas: 3
        loadBalancer:
          enabled: true
          region: hel1

    nodeGroups:
      bareMetal:
        - name: general
          labels:
            node-role.kubernetes.io/general: ""
            node.cluster.x-k8s.io/nodegroup: general
          taints: []
          bareMetalHosts:
            - serverID: "2836489" # 116.202.170.35
              wwns:
                - "eui.002538bb31c60104"
                - "eui.002538bb31c600e5"
            - serverID: "2836490" # 116.202.170.31
              wwns:
                - "eui.002538b531a43d51"
                - "eui.002538b531a43d50"
            - serverID: "2836504" # 116.202.170.33
              wwns:
                - "eui.000000000000000100a075255218338c"
                - "eui.000000000000000100a07525521833ce"

